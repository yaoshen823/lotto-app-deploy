<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§æ¨‚é€AIé¡§å•</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ SheetJS (ç”¨æ–¼ Excel æª”æ¡ˆ I/O) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script type="module">
        // æ¨¡çµ„åŒ– Firebase è¼‰å…¥
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, setDoc, doc, writeBatch, getDocs, limit, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Tailwind Configuration (ç•¥)
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#DC2626', 
                        'secondary': '#FACC15', 
                        'dark-bg': '#1F2937', 
                        'card-bg': '#374151', 
                    }
                }
            }
        }
        
        // --- å…¨å±€è®Šæ•¸ ---
        let db = null;
        let auth = null;
        let userId = 'loading'; 
        let isAuthReady = false;
        let dataStore = [];
        let unsubscribe = () => {}; 

        // Firestore è·¯å¾‘
        let COLLECTION_PATH = '';

        // åˆå§‹æ•¸æ“šé›† (78 ç­† 2025 å¹´ç´€éŒ„)
        const initialLottoData = [
            {"drawId": "114000001", "date": "01/03", "main": [6, 9, 15, 29, 30, 48], "special": 23},
            {"drawId": "114000002", "date": "01/07", "main": [1, 8, 20, 26, 29, 35], "special": 19},
            {"drawId": "114000003", "date": "01/10", "main": [14, 29, 35, 36, 37, 49], "special": 40},
            {"drawId": "114000004", "date": "01/14", "main": [1, 3, 13, 15, 37, 48], "special": 42},
            {"drawId": "114000005", "date": "01/17", "main": [11, 18, 32, 39, 44, 49], "special": 46},
            {"drawId": "114000006", "date": "01/21", "main": [6, 21, 35, 36, 38, 42], "special": 22},
            {"drawId": "114000007", "date": "01/24", "main": [6, 22, 23, 30, 36, 37], "special": 13},
            {"drawId": "114000008", "date": "01/28", "main": [2, 17, 19, 21, 23, 39], "special": 38},
            {"drawId": "114000009", "date": "01/31", "main": [4, 11, 19, 21, 38, 43], "special": 1},
            {"drawId": "114000010", "date": "02/04", "main": [10, 15, 17, 28, 41, 48], "special": 45},
            {"drawId": "114000011", "date": "02/07", "main": [1, 10, 11, 31, 33, 44], "special": 43},
            {"drawId": "114000012", "date": "02/11", "main": [12, 16, 24, 27, 34, 49], "special": 36},
            {"drawId": "114000013", "date": "02/14", "main": [7, 12, 18, 23, 27, 30], "special": 41},
            {"drawId": "114000014", "date": "02/18", "main": [5, 11, 13, 16, 33, 39], "special": 46},
            {"drawId": "114000015", "date": "02/21", "main": [3, 22, 28, 36, 39, 43], "special": 35},
            {"drawId": "114000016", "date": "02/25", "main": [10, 20, 27, 32, 41, 44], "special": 47},
            {"drawId": "114000017", "date": "02/28", "main": [15, 23, 26, 30, 40, 44], "special": 1},
            {"drawId": "114000018", "date": "03/03", "main": [7, 8, 11, 18, 34, 49], "special": 15},
            {"drawId": "114000019", "date": "03/06", "main": [4, 15, 21, 23, 30, 42], "special": 32},
            {"drawId": "114000020", "date": "03/10", "main": [1, 12, 16, 21, 37, 40], "special": 47},
            {"drawId": "114000021", "date": "03/13", "main": [3, 11, 25, 28, 33, 46], "special": 2},
            {"drawId": "114000022", "date": "03/17", "main": [2, 10, 14, 25, 29, 39], "special": 38},
            {"drawId": "114000023", "date": "03/20", "main": [5, 6, 22, 24, 31, 41], "special": 18},
            {"drawId": "114000024", "date": "03/24", "main": [10, 13, 26, 29, 32, 42], "special": 14},
            {"drawId": "114000025", "date": "03/27", "main": [1, 5, 18, 22, 38, 48], "special": 44},
            {"drawId": "114000026", "date": "03/31", "main": [13, 27, 33, 39, 45, 46], "special": 19},
            {"drawId": "114000027", "date": "04/04", "main": [7, 20, 29, 40, 43, 47], "special": 28},
            {"drawId": "114000028", "date": "04/08", "main": [10, 26, 33, 39, 45, 46], "special": 19},
            {"drawId": "114000029", "date": "04/11", "main": [6, 10, 11, 17, 23, 32], "special": 27},
            {"drawId": "114000030", "date": "04/15", "main": [18, 28, 37, 41, 43, 46], "special": 11},
            {"drawId": "114000031", "date": "04/18", "main": [2, 8, 15, 22, 29, 45], "special": 9},
            {"drawId": "114000032", "date": "04/22", "main": [1, 6, 14, 19, 35, 49], "special": 8},
            {"drawId": "114000033", "date": "04/25", "main": [20, 21, 24, 25, 31, 35], "special": 28},
            {"drawId": "114000034", "date": "04/29", "main": [7, 11, 24, 26, 30, 42], "special": 37},
            {"drawId": "114000035", "date": "05/02", "main": [2, 5, 39, 43, 45, 47], "special": 26},
            {"drawId": "114000036", "date": "05/06", "main": [5, 8, 9, 25, 30, 45], "special": 31},
            {"drawId": "114000037", "date": "05/09", "main": [15, 27, 33, 42, 48, 49], "special": 39},
            {"drawId": "114000038", "date": "05/13", "main": [1, 23, 29, 41, 45, 49], "special": 24},
            {"drawId": "114000039", "date": "05/16", "main": [13, 16, 22, 23, 34, 39], "special": 14},
            {"drawId": "114000040", "date": "05/20", "main": [2, 11, 15, 26, 29, 48], "special": 31},
            {"drawId": "114000041", "date": "05/23", "main": [1, 7, 11, 24, 44, 48], "special": 10},
            {"drawId": "114000042", "date": "05/27", "main": [16, 17, 26, 29, 32, 40], "special": 10},
            {"drawId": "114000043", "date": "05/30", "main": [3, 4, 13, 21, 38, 46], "special": 2},
            {"drawId": "114000044", "date": "06/03", "main": [9, 24, 32, 40, 41, 49], "special": 27},
            {"drawId": "114000045", "date": "06/06", "main": [11, 13, 15, 39, 42, 46], "special": 28},
            {"drawId": "114000046", "date": "06/10", "main": [3, 5, 12, 16, 22, 48], "special": 30},
            {"drawId": "114000047", "date": "06/13", "main": [1, 2, 10, 13, 20, 27], "special": 49},
            {"drawId": "114000048", "date": "06/17", "main": [13, 20, 21, 26, 31, 44], "special": 28},
            {"drawId": "114000049", "date": "06/20", "main": [4, 20, 31, 40, 42, 48], "special": 24},
            {"drawId": "114000050", "date": "06/24", "main": [3, 8, 20, 37, 45, 49], "special": 21},
            {"drawId": "114000051", "date": "06/27", "main": [4, 8, 9, 14, 21, 39], "special": 37},
            {"drawId": "114000052", "date": "07/01", "main": [8, 9, 21, 25, 33, 34], "special": 2},
            {"drawId": "114000053", "date": "07/04", "main": [5, 13, 15, 18, 33, 37], "special": 45},
            {"drawId": "114000054", "date": "07/08", "main": [6, 8, 12, 14, 25, 35], "special": 49},
            {"drawId": "114000055", "date": "07/11", "main": [15, 16, 26, 34, 48, 49], "special": 46},
            {"drawId": "114000056", "date": "07/15", "main": [32, 33, 41, 45, 46, 49], "special": 10},
            {"drawId": "114000057", "date": "07/18", "main": [2, 25, 36, 37, 38, 46], "special": 24},
            {"drawId": "114000058", "date": "07/22", "main": [5, 17, 19, 26, 27, 39], "special": 10},
            {"drawId": "114000059", "date": "07/25", "main": [2, 4, 23, 35, 41, 47], "special": 6},
            {"drawId": "114000060", "date": "07/29", "main": [2, 5, 14, 19, 36, 45], "special": 43},
            {"drawId": "114000061", "date": "08/01", "main": [4, 14, 19, 28, 40, 41], "special": 31},
            {"drawId": "114000062", "date": "08/05", "main": [1, 20, 34, 36, 37, 40], "special": 3},
            {"drawId": "114000063", "date": "08/08", "main": [11, 16, 17, 21, 24, 29], "special": 34},
            {"drawId": "114000064", "date": "08/12", "main": [6, 7, 15, 22, 37, 42], "special": 36},
            {"drawId": "114000065", "date": "08/15", "main": [3, 5, 7, 15, 17, 47], "special": 34},
            {"drawId": "114000066", "date": "08/19", "main": [2, 23, 25, 33, 41, 46], "special": 22},
            {"drawId": "114000067", "date": "08/22", "main": [23, 33, 38, 43, 45, 47], "special": 36},
            {"drawId": "114000068", "date": "08/26", "main": [3, 6, 22, 32, 35, 39], "special": 27},
            {"drawId": "114000069", "date": "08/29", "main": [13, 20, 25, 27, 28, 32], "special": 2},
            {"drawId": "114000070", "date": "09/02", "main": [2, 6, 9, 19, 20, 30], "special": 25},
            {"drawId": "114000071", "date": "09/05", "main": [10, 13, 14, 17, 19, 29], "special": 40},
            {"drawId": "114000072", "date": "09/09", "main": [12, 20, 25, 26, 40, 45], "special": 34},
            {"drawId": "114000073", "date": "09/12", "main": [2, 3, 4, 11, 15, 41], "special": 26},
            {"drawId": "114000074", "date": "09/16", "main": [7, 17, 18, 22, 25, 47], "special": 38},
            {"drawId": "114000075", "date": "09/19", "main": [14, 17, 26, 36, 38, 41], "special": 8},
            {"drawId": "114000076", "date": "09/23", "main": [5, 14, 22, 25, 27, 45], "special": 3},
            {"drawId": "114000077", "date": "09/26", "main": [1, 2, 25, 29, 41, 49], "special": 35},
            {"drawId": "114000078", "date": "09/30", "main": [19, 20, 22, 32, 36, 42], "special": 35}
        ];
        
        // --- è¨­å®šæ‚¨è‡ªå·±çš„ Firebase Config ---
        // !!! WARNING !!! 
        // ç‚ºäº†åœ¨å¤–éƒ¨å¹³å°é‹è¡Œï¼Œæ‚¨å¿…é ˆæ›¿æ›ä¸‹é¢çš„ YOUR_FIREBASE_CONFIG
        // å¦‚æœæ‚¨å·²ç¶“æœ‰ä¸€å€‹ Firebase å°ˆæ¡ˆï¼Œè«‹å°‡æ‚¨çš„å°ˆæ¡ˆé…ç½®è²¼åœ¨é€™è£¡ã€‚
        // å¦‚æœæ‚¨æ²’æœ‰ï¼Œæ‚¨éœ€è¦å…ˆå»ºç«‹ä¸€å€‹ Firebase å°ˆæ¡ˆï¼Œä¸¦å–å¾— Web App çš„è¨­å®šã€‚
        const EXTERNAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyC0GlNeFeV5_R05imC1OWmyNdP1OR2c6MI",
            authDomain: "lotto-analyzer-e424e.firebaseapp.com",
            projectId: "lotto-analyzer-e424e",
            storageBucket: "lotto-analyzer-e424e.firebasestorage.app",
            messagingSenderId: "932809120947",
            appId: "1:932809120947:web:b2dc105adff390c31ba4c6",
            measurementId: "G-PESKZ6YGT1"
        };
        
        // --- æ ¸å¿ƒåˆå§‹åŒ–æµç¨‹ (å·²ä¿®æ”¹ç‚ºè·¨å¹³å°å…¼å®¹) ---

        async function initializeFirebase() {
            // ç¢ºä¿éŒ¯èª¤è¨Šæ¯ div å­˜åœ¨
            const errorDisplay = document.getElementById('error-display');
            const loadingIndicator = document.getElementById('loading-indicator');
            const mainContent = document.getElementById('main-content');
            
            errorDisplay.classList.add('hidden');

            try {
                let config = EXTERNAL_FIREBASE_CONFIG;
                let appIdForPath = config.projectId || 'external-app';

                // 1. ç’°å¢ƒæª¢æŸ¥èˆ‡é…ç½®è¼‰å…¥
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    // Canvas ç’°å¢ƒ
                    config = JSON.parse(__firebase_config);
                    appIdForPath = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                } else if (config.apiKey === "YOUR_FIREBASE_API_KEY") {
                    // å¤–éƒ¨ç’°å¢ƒä½†é…ç½®æœªä¿®æ”¹
                    throw new Error("é…ç½®éŒ¯èª¤ï¼šè«‹å°‡ç¨‹å¼ç¢¼ä¸­çš„ 'YOUR_FIREBASE_API_KEY' æ›¿æ›ç‚ºæ‚¨å€‹äººçš„ Firebase å°ˆæ¡ˆé…ç½®ã€‚");
                } 

                if (!config || !config.apiKey) {
                    throw new Error("Firebase configuration is missing or invalid.");
                }

                // 2. åˆå§‹åŒ– Firebase æœå‹™
                const app = initializeApp(config);
                db = getFirestore(app);
                auth = getAuth(app);
                
                setLogLevel('debug');
                COLLECTION_PATH = `artifacts/${appIdForPath}/public/data/lotto_draws`;
                
                // 3. èº«ä»½é©—è­‰ (å¼·åˆ¶åŒ¿åç™»å…¥æˆ–ä½¿ç”¨ Token)
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth); 
                }

                userId = auth.currentUser?.uid || 'anonymous';
                isAuthReady = true;

                // 4. æª¢æŸ¥ä¸¦å¯«å…¥åˆå§‹æ•¸æ“š
                await seedInitialData();

                // 5. å»ºç«‹å¯¦æ™‚ç›£è½
                setupRealtimeListener();
                
                // 6. è¨­ç½®äº‹ä»¶ç›£è½å™¨ (ç¢ºä¿åªè¨­ç½®ä¸€æ¬¡)
                document.getElementById('add-result-form').addEventListener('submit', handleAddResult);
                document.getElementById('export-data-btn').addEventListener('click', exportData);
                document.getElementById('import-file-input').addEventListener('change', importData);
                
                // 7. é¡¯ç¤º UI
                loadingIndicator.classList.add('hidden');
                mainContent.classList.remove('hidden');
                //document.getElementById('user-id-display').textContent = `User ID: ${userId} (Collection: ${COLLECTION_PATH})`;

            } catch (error) {
                console.error("Firebase å•Ÿå‹•å¤±æ•—:", error);
                loadingIndicator.classList.add('hidden');
                mainContent.classList.add('hidden');
                
                errorDisplay.innerHTML = `
                    <div class="p-6 rounded-xl shadow-2xl bg-red-900/40 border-l-4 border-red-500 max-w-xl mx-auto mt-20">
                        <p class="text-xl font-bold text-red-300">âŒ æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•å¤±æ•—</p>
                        <p class="text-sm mt-2 text-red-200">éŒ¯èª¤è¨Šæ¯: ${error.message}</p>
                        <p class="text-sm mt-4 text-yellow-300">
                           <span class="font-bold">éƒ¨ç½²æç¤º:</span> 
                           å¦‚æœç¶²é ä¸€ç‰‡ç©ºç™½ï¼Œè«‹å‹™å¿…æª¢æŸ¥ï¼š
                           <ul class="list-disc list-inside mt-2 ml-4 space-y-1">
                               <li>æ˜¯å¦åœ¨ç¨‹å¼ç¢¼ä¸­æ›¿æ›äº†æ‚¨çš„ Firebase <code class="bg-gray-700 p-1 rounded">EXTERNAL_FIREBASE_CONFIG</code>ã€‚</li>
                               <li>Firebase å°ˆæ¡ˆæ˜¯å¦å•Ÿç”¨äº† **åŒ¿åç™»å…¥ (Anonymous Sign-In)**ã€‚</li>
                               <li>Firestore å®‰å…¨è¦å‰‡æ˜¯å¦å…è¨±åŒ¿åç”¨æˆ¶è®€å¯«ã€‚</li>
                           </ul>
                        </p>
                    </div>`;
                errorDisplay.classList.remove('hidden');
            }
        }
        
        // ... (å…¶ä»–å‡½æ•¸ä¿æŒä¸è®Š)
        async function seedInitialData() {
            try {
                if (!db) return;
                const q = query(collection(db, COLLECTION_PATH), limit(1));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    const batch = writeBatch(db);
                    let counter = 0;
                    initialLottoData.forEach(record => {
                        const docRef = doc(db, COLLECTION_PATH, record.drawId);
                        batch.set(docRef, {
                            ...record,
                            date: record.date.toString().trim(), 
                            timestamp: serverTimestamp() 
                        });
                        counter++;
                    });
                    await batch.commit();
                }
            } catch (error) {
                console.error("å¯«å…¥åˆå§‹æ•¸æ“šå¤±æ•—:", error);
            }
        }


        function setupRealtimeListener() {
            unsubscribe(); 
            
            if (!db || !isAuthReady) return;
            
            const q = query(collection(db, COLLECTION_PATH), orderBy('drawId', 'desc'));

            unsubscribe = onSnapshot(q, (snapshot) => {
                const records = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    records.push({
                        ...data,
                        drawId: doc.id, 
                    });
                });
                dataStore = records;
                processAndRenderData(dataStore);
                
            }, (error) => {
                console.error("å¯¦æ™‚ç›£è½éŒ¯èª¤:", error);
                // å³ä½¿ç›£è½å¤±æ•—ï¼Œä¹Ÿå˜—è©¦æ¸²æŸ“ç•¶å‰æ•¸æ“š
                document.getElementById('form-message').textContent = `âŒ å¯¦æ™‚æ•¸æ“šæ›´æ–°å¤±æ•—: ${error.message}`;
                document.getElementById('form-message').classList.remove('hidden', 'text-green-500', 'bg-green-900/50');
                document.getElementById('form-message').classList.add('text-red-500', 'p-2', 'rounded-lg', 'bg-red-900/50');
            });
        }

        // --- æ ¸å¿ƒåˆ†æé‚è¼¯ (ä¿æŒä¸è®Š) ---

        function processAndRenderData(records) {
             if (records.length === 0) {
                document.getElementById('prediction-results').innerHTML = '<p class="text-center text-gray-400 p-4">ç„¡æ­·å²ç´€éŒ„ï¼Œç„¡æ³•é€²è¡Œåˆ†æã€‚</p>';
                document.getElementById('freq-table').innerHTML = '<p class="text-center text-gray-500">N/A</p>';
                document.getElementById('weighted-table').innerHTML = '<p class="text-center text-gray-500">N/A</p>';
                document.getElementById('cooccurrence-table').innerHTML = '<p class="text-center text-gray-500">N/A</p>';
                document.getElementById('history-table').innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">å°šç„¡é–‹çç´€éŒ„</td></tr>';
                return;
            }

            const freqMap = new Map();
            const weightedFreqMap = new Map();
            const gapMap = new Map();
            const cooccurrenceMap = new Map();
            const numRange = Array.from({ length: 49 }, (_, i) => i + 1);
            let drawIndex = 0; 

            numRange.forEach(n => {
                freqMap.set(n, 0);
                weightedFreqMap.set(n, 0);
                gapMap.set(n, records.length); 
            });

            for (const record of records) {
                if (!record.main || !Array.isArray(record.main) || record.main.length !== 6 || isNaN(record.special)) continue;

                const allNumbers = [...record.main, record.special];
                const mainNumbers = record.main.slice().sort((a, b) => a - b);
                
                const weight = (records.length - drawIndex) / records.length; 

                for (const num of allNumbers) {
                    freqMap.set(num, (freqMap.get(num) || 0) + 1);
                    
                    if (record.main.includes(num)) {
                        weightedFreqMap.set(num, weightedFreqMap.get(num) + weight);
                    }

                    if (gapMap.get(num) === records.length) {
                        gapMap.set(num, drawIndex);
                    }
                }

                for (let i = 0; i < mainNumbers.length; i++) {
                    for (let j = i + 1; j < mainNumbers.length; j++) {
                        const pair = `${mainNumbers[i].toString().padStart(2, '0')},${mainNumbers[j].toString().padStart(2, '0')}`;
                        cooccurrenceMap.set(pair, (cooccurrenceMap.get(pair) || 0) + 1);
                    }
                }

                drawIndex++;
            }
            
            if (drawIndex === 0) {
                 document.getElementById('prediction-results').innerHTML = '<p class="text-center text-red-400 p-4">æ‰€æœ‰ç´€éŒ„çš†ç„¡æ•ˆæˆ–æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•é€²è¡Œåˆ†æã€‚</p>';
                return;
            }


            const sortedFreq = Array.from(freqMap.entries()).filter(([num]) => num <= 49 && freqMap.get(num) > 0).sort((a, b) => b[1] - a[1]);
            const sortedWeighted = Array.from(weightedFreqMap.entries()).filter(([num]) => num <= 49 && weightedFreqMap.get(num) > 0).sort((a, b) => b[1] - a[1]);
            const sortedCooccurrence = Array.from(cooccurrenceMap.entries()).sort((a, b) => b[1] - a[1]);
            const sortedGap = Array.from(gapMap.entries()).filter(([num]) => num <= 49).sort((a, b) => b[1] - a[1]);

            const predictions = generatePredictions(sortedWeighted, sortedFreq, sortedGap);
            renderStats(records, sortedFreq.slice(0, 10), sortedWeighted.slice(0, 10), sortedCooccurrence.slice(0, 10), predictions);
        }
        
        function generatePredictions(sortedWeighted, sortedFreq, sortedGap) {
            const safePick = (sourceArray, existingSet, n) => {
                const picked = [];
                const localSet = new Set(existingSet);
                let available = sourceArray.map(item => item[0]).filter(num => !localSet.has(num));

                const pickFromRange = (arr, count) => arr.sort(() => 0.5 - Math.random()).slice(0, count);

                const ranges = { low: [], mid: [], high: [] };
                available.forEach(num => {
                    if (num >= 1 && num <= 16) ranges.low.push(num);
                    else if (num >= 17 && num <= 32) ranges.mid.push(num);
                    else if (num >= 33 && num <= 49) ranges.high.push(num);
                });

                picked.push(...pickFromRange(ranges.low, Math.min(2, ranges.low.length)));
                picked.push(...pickFromRange(ranges.mid, Math.min(2, ranges.mid.length)));
                picked.push(...pickFromRange(ranges.high, Math.min(2, ranges.high.length)));
                
                const needed = n - picked.length;
                if (needed > 0) {
                     const remaining = available.filter(num => !picked.includes(num));
                     picked.push(...remaining.slice(0, needed));
                }

                return picked.slice(0, n);
            };

            const generateSpecialPicks = (mainNumbers) => {
                const mainSet = new Set(mainNumbers);
                const candidates = sortedFreq
                    .slice(0, 15) 
                    .map(([num]) => num)
                    .filter(num => num <= 49 && !mainSet.has(num))
                    .sort(() => 0.5 - Math.random());

                const specialPicks = candidates.slice(0, 3).map(n => n.toString().padStart(2, '0'));
                
                while (specialPicks.length < 3) {
                    const rand = Math.floor(Math.random() * 49) + 1;
                    if (!mainSet.has(rand) && !specialPicks.includes(rand.toString().padStart(2, '0'))) {
                        specialPicks.push(rand.toString().padStart(2, '0'));
                    }
                }
                return specialPicks.slice(0, 3).join(', ');
            }

            let set1 = safePick(sortedWeighted, new Set(), 6, false);
            set1 = set1.sort((a, b) => a - b).map(n => n.toString().padStart(2, '0'));
            const special1 = generateSpecialPicks(set1.map(Number));

            const hotCandidates = sortedWeighted.slice(0, 10);
            const coldCandidates = sortedGap.slice(0, 10);
            
            const top3Hot = safePick(hotCandidates, new Set(), 3, false);
            const top3Cold = safePick(coldCandidates, new Set(top3Hot), 3, true);
            
            let set2 = [...top3Hot, ...top3Cold];
            
            while (set2.length < 6) {
                const rand = Math.floor(Math.random() * 49) + 1;
                if (!set2.includes(rand)) {
                    set2.push(rand);
                }
            }

            set2 = set2.slice(0, 6).sort((a, b) => a - b).map(n => n.toString().padStart(2, '0'));
            const special2 = generateSpecialPicks(set2.map(Number));


            return [
                {
                    name: "ç­–ç•¥ä¸€ï¼šè¿‘æœŸç†±é–€ä¸»å° (ç©©å¥å‹)",
                    numbers: set1.join(', '),
                    special: special1,
                    basis: "åŸºæ–¼è¿‘ç«¯åŠ æ¬Šé »ç‡æ’åå‰åˆ—çš„è™Ÿç¢¼çµ„åˆï¼Œå´é‡æ•æ‰çŸ­æœŸå…§æ´»èºçš„è™Ÿç¢¼ã€‚",
                },
                {
                    name: "ç­–ç•¥äºŒï¼šå†·ç†±è™Ÿå‡è¡¡ (å›è£œå‹)",
                    numbers: set2.join(', '),
                    special: special2,
                    basis: "çµåˆäº†åŠ æ¬Šç†±é–€è™Ÿ (3å€‹) èˆ‡é•·é–“éš”å†·é–€è™Ÿ (3å€‹)ï¼ŒæœŸæœ›å¯¦ç¾å¹³è¡¡å›è£œã€‚",
                }
            ];
        }

        function renderStats(records, sortedFreq, sortedWeighted, sortedCooccurrence, predictions) {
            document.getElementById('freq-table').innerHTML = sortedFreq.map(([num, count]) => `
                <div class="flex justify-between items-center p-2 border-b border-card-bg/50">
                    <span class="text-lg font-bold w-1/3 text-secondary">${num.toString().padStart(2, '0')}</span>
                    <span class="w-2/3 text-right">${count} æ¬¡</span>
                </div>
            `).join('');

            document.getElementById('weighted-table').innerHTML = sortedWeighted.map(([num, score]) => `
                <div class="flex justify-between items-center p-2 border-b border-card-bg/50">
                    <span class="text-lg font-bold w-1/3 text-primary">${num.toString().padStart(2, '0')}</span>
                    <span class="w-2/3 text-right">${score.toFixed(2)} åˆ†</span>
                </div>
            `).join('');
            
            document.getElementById('cooccurrence-table').innerHTML = sortedCooccurrence.map(([pair, count]) => `
                <div class="flex justify-between items-center p-2 border-b border-card-bg/50">
                    <span class="text-lg font-bold w-1/3 text-secondary">${pair}</span>
                    <span class="w-2/3 text-right">${count} æ¬¡</span>
                </div>
            `).join('');

            document.getElementById('prediction-results').innerHTML = predictions.map(p => `
                <div class="bg-card-bg p-4 rounded-xl shadow-lg mb-4 border-l-4 border-primary">
                    <h3 class="text-xl font-bold mb-3 text-primary">${p.name}</h3>
                    <div class="flex flex-wrap gap-2 mb-3">
                        ${p.numbers.split(', ').map(n => `<span class="lotto-ball main">${n}</span>`).join('')}
                    </div>
                    <p class="text-gray-300 text-sm mb-2">${p.basis}</p>
                    <div class="flex items-center mt-3">
                        <span class="text-sm mr-2 text-secondary">ç‰¹åˆ¥è™Ÿå»ºè­°:</span>
                        ${p.special.split(', ').map(n => `<span class="lotto-ball special">${n}</span>`).join('')}
                    </div>
                </div>
            `).join('');
            
            // æ­·å²ç´€éŒ„è¡¨æ ¼å‘ˆç¾
            document.getElementById('history-table').innerHTML = records.map(r => `
                <tr class="border-b border-card-bg/50 hover:bg-card-bg/70">
                    <td class="px-4 py-2 text-primary text-sm font-semibold">${r.drawId || 'N/A'}</td>
                    <td class="px-4 py-2 text-secondary">${r.date}</td>
                    <td class="px-4 py-2 text-center text-gray-200">${r.main.map(n => n.toString().padStart(2, '0')).join(', ')}</td>
                    <td class="px-4 py-2 text-center">
                        <span class="lotto-ball special">${r.special.toString().padStart(2, '0')}</span>
                    </td>
                </tr>
            `).join('');
        }

        // --- Firestore å¯«å…¥èˆ‡ I/O è™•ç† (èˆ‡å‰ç‰ˆç›¸åŒ) ---
        
        async function writeRecordToFirestore(record) {
            if (!db) throw new Error("Firestore å°šæœªåˆå§‹åŒ–æˆ–æ¬Šé™ä¸è¶³ã€‚");
            
            const docRef = doc(db, COLLECTION_PATH, record.drawId);
            
            await setDoc(docRef, {
                drawId: record.drawId,
                date: record.date,
                main: record.main,
                special: record.special,
                timestamp: serverTimestamp() 
            });
        }

        async function handleAddResult(e) {
            e.preventDefault();
            const messageEl = document.getElementById('form-message');
            messageEl.classList.remove('hidden');
            messageEl.classList.remove('text-red-500', 'bg-red-900/50', 'text-yellow-500', 'bg-yellow-900/50', 'text-green-500', 'bg-green-900/50', 'p-2', 'rounded-lg');
            
            const drawIdInput = document.getElementById('draw-id').value.trim(); 
            const dateInput = document.getElementById('draw-date').value; 
            const mainInput = document.getElementById('main-numbers').value;
            const specialInput = document.getElementById('special-number').value;

            if (!drawIdInput) {
                 messageEl.textContent = 'âŒ è«‹è¼¸å…¥ã€ŒæœŸåˆ¥ã€æ¬„ä½ã€‚';
                messageEl.classList.add('text-red-500', 'p-2', 'rounded-lg', 'bg-red-900/50');
                return;
            }

            const mainNumbers = mainInput.split(/[,\s]+/) 
                .map(s => parseInt(s.trim()))
                .filter(n => !isNaN(n) && n >= 1 && n <= 49); 
            const specialNumber = parseInt(specialInput.trim());

            const allNums = [...mainNumbers, specialNumber];
            if (!dateInput || mainNumbers.length !== 6 || isNaN(specialNumber) || mainNumbers.includes(specialNumber) || 
                (new Set(allNums)).size !== 7 || allNums.some(n => n < 1 || n > 49 || isNaN(n))) {
                messageEl.textContent = 'âŒ è«‹æª¢æŸ¥è¼¸å…¥ï¼šæ—¥æœŸã€6å€‹ä¸»è™Ÿï¼ˆä¸é‡è¤‡ï¼‰å’Œ1å€‹ç‰¹åˆ¥è™Ÿï¼ˆä¸èˆ‡ä¸»è™Ÿé‡è¤‡ï¼‰ï¼Œä¸”è™Ÿç¢¼ä»‹æ–¼ 01-49ã€‚';
                messageEl.classList.add('text-red-500', 'p-2', 'rounded-lg', 'bg-red-900/50');
                return;
            }

            try {
                const isExistByDrawId = dataStore.some(record => record.drawId === drawIdInput);
                if (isExistByDrawId) {
                    messageEl.textContent = `âŒ éŒ¯èª¤ï¼šã€ŒæœŸåˆ¥ã€ ${drawIdInput} çš„ç´€éŒ„å·²å­˜åœ¨ã€‚`;
                    messageEl.classList.add('text-red-500', 'p-2', 'rounded-lg', 'bg-red-900/50');
                    return;
                }
                
                // --- æ—¥æœŸæ ¼å¼ä¿®æ­£ï¼šå°‡ YYYY-MM-DD è½‰ç‚º MM/DD ---
                const dateParts = dateInput.split('-');
                const docDate = `${dateParts[1].padStart(2, '0')}/${dateParts[2].padStart(2, '0')}`;
                
                const newRecord = {
                    drawId: drawIdInput,
                    date: docDate, 
                    main: mainNumbers.sort((a, b) => a - b),
                    special: specialNumber
                };

                await writeRecordToFirestore(newRecord);
                
                messageEl.textContent = `âœ… æœŸåˆ¥ ${drawIdInput} ç´€éŒ„æ–°å¢æˆåŠŸï¼Œåˆ†ææ•¸æ“šå·²è‡ªå‹•æ›´æ–°ï¼`;
                messageEl.classList.add('text-green-500', 'p-2', 'rounded-lg', 'bg-green-900/50');
                e.target.reset(); 
            } catch (error) {
                console.error("å¯«å…¥ Firestore å¤±æ•—: ", error);
                messageEl.textContent = `âŒ æ–°å¢ç´€éŒ„å¤±æ•— (Firestore éŒ¯èª¤): ${error.message}. è«‹æª¢æŸ¥æ‚¨çš„ Firebase å®‰å…¨è¦å‰‡æ˜¯å¦å…è¨±å¯«å…¥ã€‚`;
                messageEl.classList.add('text-red-500', 'p-2', 'rounded-lg', 'bg-red-900/50');
            }
        }
        
        
        function exportData() {
            const dataForExcel = dataStore.map(record => ({
                'æœŸåˆ¥': record.drawId || '', 
                'æ—¥æœŸ': record.date, 
                'ä¸»è™Ÿ': record.main.map(n => n.toString().padStart(2, '0')).join(', '),
                'ç‰¹åˆ¥è™Ÿ': record.special.toString().padStart(2, '0')
            }));

            const ws = XLSX.utils.json_to_sheet(dataForExcel);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "å¤§æ¨‚é€ç´€éŒ„");

            const filename = 'å¤§æ¨‚é€æ­·å²ç´€éŒ„_Firestore.xlsx';
            XLSX.writeFile(wb, filename);

            const messageEl = document.getElementById('form-message');
            messageEl.textContent = `âœ… è³‡æ–™å·²åŒ¯å‡ºç‚º ${filename} æª”æ¡ˆï¼`;
            messageEl.classList.remove('hidden', 'text-red-500', 'bg-red-900/50', 'text-yellow-500', 'bg-yellow-900/50');
            messageEl.classList.add('text-green-500', 'p-2', 'rounded-lg', 'bg-green-900/50');
        }

        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            const messageEl = document.getElementById('form-message');
            messageEl.classList.remove('hidden');
            messageEl.classList.remove('text-red-500', 'bg-red-900/50', 'text-yellow-500', 'bg-yellow-900/50', 'text-green-500', 'bg-green-900/50', 'p-2', 'rounded-lg');


            reader.onload = async function(event) {
                let newRecords = [];
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const importedJson = XLSX.utils.sheet_to_json(sheet);
                    
                    if (!Array.isArray(importedJson) || importedJson.length === 0) {
                        throw new Error("åŒ¯å…¥çš„æª”æ¡ˆç„¡æœ‰æ•ˆæ•¸æ“šã€‚");
                    }
                    
                    importedJson.forEach((row, index) => {
                        const drawId = row['æœŸåˆ¥'] ? row['æœŸåˆ¥'].toString() : null; 
                        const special = parseInt(row['ç‰¹åˆ¥è™Ÿ']);
                        const dateRaw = row['é–‹çæ—¥æœŸ'] || row['æ—¥æœŸ']; 
                        
                        if (!drawId || !dateRaw || isNaN(special)) {
                            return; 
                        }
                        
                        let mainNums = [];
                        if (row['ä¸»è™Ÿ']) {
                            mainNums = row['ä¸»è™Ÿ'].toString().split(/[,\s]+/) 
                                .map(s => parseInt(s.trim()))
                                .filter(n => !isNaN(n) && n >= 1 && n <= 49); 
                        } else {
                            for (let i = 1; i <= 6; i++) {
                                const numKey = `çè™Ÿ${i}`;
                                const num = parseInt(row[numKey]);
                                if (!isNaN(num) && num >= 1 && num <= 49) {
                                    mainNums.push(num);
                                }
                            }
                        }
                        
                        if (mainNums.length !== 6 || mainNums.includes(special) || (new Set(mainNums)).size !== 6) {
                             throw new Error(`ç¬¬ ${index + 1} è¡Œæ•¸æ“šæ ¼å¼éŒ¯èª¤ï¼šä¸»è™Ÿæ•¸é‡æˆ–è¦å‰‡ä¸ç¬¦ã€‚`);
                        }
                        
                        let formattedDate = dateRaw.toString();
                        if (typeof dateRaw === 'number') {
                            const date = XLSX.SSF.parse_date_code(dateRaw);
                            formattedDate = `${(date.m).toString().padStart(2, '0')}/${(date.d).toString().padStart(2, '0')}`;
                        } else {
                            const dateParts = formattedDate.match(/(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
                            if (dateParts) {
                                formattedDate = `${dateParts[2].padStart(2, '0')}/${dateParts[3].padStart(2, '0')}`;
                            } else {
                                formattedDate = formattedDate.replace(/\//g, '/').replace(/-/g, '/');
                            }
                        }


                        newRecords.push({
                            drawId: drawId,
                            date: formattedDate, 
                            main: mainNums.sort((a, b) => a - b),
                            special: special
                        });
                    });

                    if (newRecords.length === 0) {
                        throw new Error("åŒ¯å…¥æª”æ¡ˆä¸­æ‰¾ä¸åˆ°æœ‰æ•ˆä¸”æ ¼å¼æ­£ç¢ºçš„é–‹çç´€éŒ„ã€‚è«‹æª¢æŸ¥æ¨™é ­åç¨±æ˜¯å¦æ­£ç¢ºã€‚");
                    }

                    const batch = writeBatch(db);
                    let importedCount = 0;
                    
                    for (const record of newRecords) {
                        if (!dataStore.some(r => r.drawId === record.drawId)) {
                             const docRef = doc(db, COLLECTION_PATH, record.drawId);
                             batch.set(docRef, {
                                ...record,
                                timestamp: serverTimestamp() 
                             });
                             importedCount++;
                        }
                    }

                    if (importedCount > 0) {
                        await batch.commit();
                        messageEl.textContent = `âœ… æˆåŠŸåŒ¯å…¥ ${importedCount} ç­†æ–°ç´€éŒ„ï¼åˆ†ææ•¸æ“šå·²è‡ªå‹•æ›´æ–°ã€‚`;
                        messageEl.classList.add('text-green-500', 'p-2', 'rounded-lg', 'bg-green-900/50');
                    } else {
                        messageEl.textContent = `âš ï¸ è­¦å‘Šï¼šæ‰€æœ‰ç´€éŒ„çš„æœŸåˆ¥éƒ½å·²å­˜åœ¨æ–¼æ•¸æ“šåº«ä¸­ï¼Œæœªå¯«å…¥ä»»ä½•æ–°ç´€éŒ„ã€‚`;
                        messageEl.classList.add('text-yellow-500', 'p-2', 'rounded-lg', 'bg-yellow-900/50');
                    }

                } catch (error) {
                    console.error("Import failed:", error);
                    messageEl.textContent = `âŒ åŒ¯å…¥å¤±æ•— (å¯«å…¥éŒ¯èª¤)ï¼š${error.message || 'è«‹ç¢ºä¿æª”æ¡ˆæ ¼å¼æ­£ç¢ºã€‚'}`;
                    messageEl.classList.add('text-red-500', 'p-2', 'rounded-lg', 'bg-red-900/50');
                } finally {
                    e.target.value = ''; 
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // --- å•Ÿå‹•ç¨‹åº ---
        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #374151; }
        ::-webkit-scrollbar-thumb { background: #DC2626; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #B91C1C; }
        /* Lotto ball styling */
        .lotto-ball {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-weight: bold;
            color: #1F2937;
            font-size: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -2px rgba(0, 0, 0, 0.5);
            border: 2px solid;
            transition: transform 0.2s;
        }
        .lotto-ball.main {
            background: linear-gradient(145deg, #FFEFBA, #FFD700); /* Golden color for main */
            border-color: #DAA520;
        }
        .lotto-ball.special {
            background: linear-gradient(145deg, #FF6B6B, #DC2626); /* Red color for special */
            color: white;
            border-color: #991B1B;
        }
        .lotto-ball:hover {
            transform: scale(1.05);
        }
        @media (max-width: 768px) {
            .lotto-ball {
                width: 30px;
                height: 30px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body class="bg-dark-bg text-gray-100 min-h-screen p-4 font-sans antialiased">

    <!-- éŒ¯èª¤é¡¯ç¤ºå€å¡Š (æ–°çš„ï¼Œç¨ç«‹æ–¼ main-content) -->
    <div id="error-display" class="hidden"></div>
    
    <!-- é é¢çµæ§‹ -->
    <div class="max-w-7xl mx-auto py-6">

        <header class="text-center mb-8 border-b border-primary pb-4">
            <h1 class="text-4xl md:text-5xl font-extrabold text-white tracking-tight">å¤§æ¨‚é€AIé¡§å•ğŸ”®</h1>
            <p class="text-secondary mt-2 text-lg">æ­·å²æ•¸æ“šçµ±è¨ˆèˆ‡ä¸‹ä¸€æœŸå€™é¸è™Ÿç¢¼å»ºè­°</p>
        </header>

        <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
        <div id="loading-indicator" class="flex flex-col justify-center items-center h-64">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-primary"></div>
            <p class="text-white ml-4 text-xl mt-4">Firebase è³‡æ–™åº«é€£æ¥ä¸­ï¼Œè«‹ç¨å€™...</p>
        </div>

        <!-- ä¸»è¦å…§å®¹å€å¡Š -->
        <div id="main-content" class="hidden">
            <p id="user-id-display" class="text-sm text-gray-500 mb-4 text-center"></p>

            <!-- éƒ¨ç½²æç¤º (åƒ…ä¾›å¤–éƒ¨å¹³å°ç”¨æˆ¶é–±è®€) 
            <div class="bg-yellow-900/40 border-l-4 border-yellow-400 p-4 mb-8 rounded-lg text-yellow-100">
                <p class="font-bold text-lg">ğŸ“¢ è·¨å¹³å°éƒ¨ç½²æç¤º (å‹™å¿…æª¢æŸ¥):</p>
                <ul class="list-disc list-inside mt-2 text-sm space-y-1">
                    <li>è«‹ç¢ºèªæ‚¨å·²åœ¨ç¨‹å¼ç¢¼ä¸­æ›¿æ› **`EXTERNAL_FIREBASE_CONFIG`** è®Šæ•¸ã€‚</li>
                    <li>è«‹ç¢ºèª Firebase å°ˆæ¡ˆå·²å•Ÿç”¨ **åŒ¿åç™»å…¥**ï¼Œä¸” Firestore è¦å‰‡å…è¨±åŒ¿åç”¨æˆ¶è®€å¯«ã€‚</li>
                </ul>
            </div>
            -->

            <!-- é æ¸¬çµæœå€å¡Š -->
            <section class="mb-8">
                <h2 class="text-3xl font-bold text-white mb-4 border-b border-card-bg pb-2">ğŸ¯ å…©çµ„æœ€æœ‰å¯èƒ½ä¸­çè™Ÿç¢¼ (åŸºæ–¼æœ€æ–°æ•¸æ“š)</h2>
                <div id="prediction-results" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Prediction results will be injected here -->
                </div>
                <p class="text-sm text-gray-400 mt-4 p-3 bg-card-bg rounded-lg">
                    **é¢¨éšªè²æ˜**ï¼šå½©åˆ¸æœ¬è³ªç‚ºéš¨æ©Ÿç¨ç«‹æŠ½æ¨£ï¼Œå„æœŸè™Ÿç¢¼ä¸­çæ©Ÿç‡ç›¸ç­‰ï¼Œæ­·å²é–‹çæ•¸æ“šç„¡æ³•ä½œç‚ºæœªä¾†çµæœçš„é æ¸¬ä¾æ“šã€‚æœ¬å ±å‘Šåƒ…ç‚ºåŸºæ–¼æ­·å²è³‡æ–™çš„æ•¸æ“šåˆ†æèˆ‡çµ„åˆå»ºè­°ï¼Œä¸æ§‹æˆä»»ä½•æŠ•æ³¨ä¿è­‰ï¼Œåƒ…ä¾›å¨›æ¨‚åƒè€ƒã€‚
                </p>
            </section>
            
            <!-- æ•¸æ“šè¼¸å…¥èˆ‡ I/O æ§åˆ¶ -->
            <section class="mb-8 p-6 bg-card-bg rounded-xl shadow-2xl border border-primary/30">
                <h2 class="text-3xl font-bold text-white mb-4">âœï¸ æ•¸æ“šç®¡ç†èˆ‡æ›´æ–° (Firestore å¯¦æ™‚)</h2>
                
                <!-- I/O æŒ‰éˆ• -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="import-file-input" class="block text-sm font-medium text-gray-300 mb-1">åŒ¯å…¥æ•¸æ“š (XLSX/XLS æª”æ¡ˆ)</label>
                        <input type="file" id="import-file-input" accept=".xlsx,.xls" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-secondary file:text-dark-bg hover:file:bg-secondary/80">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1 invisible md:visible">åŒ¯å‡ºç•¶å‰æ•¸æ“š</label>
                        <button id="export-data-btn" class="w-full py-2 px-4 bg-primary hover:bg-red-700 text-white font-bold rounded-lg transition duration-200 shadow-md">
                            åŒ¯å‡ºç‚º XLSX æª”æ¡ˆ (å« Firestore ç´€éŒ„)
                        </button>
                    </div>
                </div>

                <!-- æ–°å¢ç´€éŒ„è¡¨å–® -->
                <h3 class="text-2xl font-semibold text-white border-t border-card-bg/50 pt-4 mb-4">æ–°å¢é–‹ççµæœ (å°‡ç›´æ¥å¯«å…¥ Firestore)</h3>
                <form id="add-result-form" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div class="col-span-1">
                        <label for="draw-id" class="block text-sm font-medium text-gray-300 mb-1">æœŸåˆ¥ (Draw ID) <span class="text-primary">*</span></label>
                        <input type="text" id="draw-id" required placeholder="ä¾‹å¦‚: 114000092" class="w-full p-2 rounded-lg bg-dark-bg border border-gray-600 text-white focus:ring-primary focus:border-primary">
                    </div>
                    <div class="col-span-1">
                        <label for="draw-date" class="block text-sm font-medium text-gray-300 mb-1">é–‹çæ—¥æœŸ (è¥¿å…ƒ) <span class="text-primary">*</span></label>
                        <input type="date" id="draw-date" required class="w-full p-2 rounded-lg bg-dark-bg border border-gray-600 text-white focus:ring-primary focus:border-primary">
                    </div>
                    <div class="col-span-2">
                        <label for="main-numbers" class="block text-sm font-medium text-gray-300 mb-1">ä¸»è™Ÿ (6å€‹, è²¼ä¸Šç©ºæ ¼æˆ–é€—è™Ÿåˆ†éš”) <span class="text-primary">*</span></label>
                        <input type="text" id="main-numbers" required placeholder="ä¾‹å¦‚: 01 07 14 22 33 45" class="w-full p-2 rounded-lg bg-dark-bg border border-gray-600 text-white focus:ring-primary focus:border-primary">
                    </div>
                    <div class="col-span-1">
                        <label for="special-number" class="block text-sm font-medium text-gray-300 mb-1">ç‰¹åˆ¥è™Ÿ <span class="text-primary">*</span></label>
                        <input type="number" id="special-number" min="1" max="49" required class="w-full p-2 rounded-lg bg-dark-bg border border-gray-600 text-white focus:ring-primary focus:border-primary">
                    </div>
                    <div class="md:col-span-5">
                        <button type="submit" class="w-full py-2 px-4 bg-primary hover:bg-red-700 text-white font-bold rounded-lg transition duration-200 shadow-md transform hover:scale-[1.01]">
                            æ–°å¢ä¸¦å¯«å…¥ Firestore
                        </button>
                    </div>
                </form>
                <p id="form-message" class="mt-3 text-center hidden"></p>
            </section>

            <!-- çµ±è¨ˆæ•¸æ“šå‘ˆç¾ -->
            <section class="mb-8">
                <h2 class="text-3xl font-bold text-white mb-4 border-b border-card-bg pb-2">ğŸ“Š æ ¸å¿ƒçµ±è¨ˆåˆ†æ (Top 10)</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- ç¸½é«”é »ç‡ -->
                    <div class="bg-card-bg p-4 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-secondary mb-3">ç¸½é«”å‡ºè™Ÿé »ç‡</h3>
                        <div id="freq-table" class="space-y-1">
                            <!-- Freq data here -->
                        </div>
                    </div>
                    <!-- è¿‘æœŸåŠ æ¬Šé »ç‡ -->
                    <div class="bg-card-bg p-4 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-primary mb-3">è¿‘æœŸåŠ æ¬Šç†±é–€è™Ÿ</h3>
                        <div id="weighted-table" class="space-y-1">
                            <!-- Weighted data here -->
                        </div>
                    </div>
                    <!-- é«˜å…±ç¾å° -->
                    <div class="bg-card-bg p-4 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-secondary mb-3">é«˜å…±ç¾å° (ä¸»è™Ÿ)</h3>
                        <div id="cooccurrence-table" class="space-y-1">
                            <!-- Cooccurrence data here -->
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- æ­·å²ç´€éŒ„ (å¢å¼·å‘ˆç¾) -->
            <section>
                <h2 class="text-3xl font-bold text-white mb-4 border-b border-card-bg pb-2">ğŸ“œ æ­·å²é–‹çç´€éŒ„ (Firestore å¯¦æ™‚åŒæ­¥)</h2>
                <div class="bg-card-bg rounded-xl shadow-lg overflow-x-auto max-h-96">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-dark-bg sticky top-0">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-300 uppercase tracking-wider">æœŸåˆ¥</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-300 uppercase tracking-wider">æ—¥æœŸ</th>
                                <th class="px-4 py-3 text-center text-sm font-medium text-gray-300 uppercase tracking-wider">ä¸»è™Ÿ (6å€‹)</th>
                                <th class="px-4 py-3 text-center text-sm font-medium text-gray-300 uppercase tracking-wider">ç‰¹åˆ¥è™Ÿ</th>
                            </tr>
                        </thead>
                        <tbody id="history-table" class="divide-y divide-gray-700">
                            <!-- History data will be injected here -->
                        </tbody>
                    </table>
                </div>
            </section>

        </div>
    </div>
</body>
</html>
